# SubFlow 环境变量配置模板
# 复制此文件为 .env 并填写实际值

# === 目录配置 ===
MODELS_DIR=./models
DATA_DIR=./data
LOG_DIR=./logs

# === Worker（GPU/音频）===
# 强制 Worker 使用 GPU 1（如果你机器上 GPU0 被占用）
CUDA_VISIBLE_DEVICES=1
# 测试/调试时可截断音频，避免长视频耗时过久（秒）
AUDIO_MAX_DURATION_S=120
# 人声分离（Demucs）为必选步骤

# === VAD（默认已较碎，可按需覆盖）===
# NeMo VAD 模型路径（.nemo）；默认会指向仓库根目录 models 下的 ModelScope 缓存
# VAD_NEMO_MODEL_PATH=./models/modelscope/models/nv-community/Frame_VAD_Multilingual_MarbleNet_v2.0/frame_vad_multilingual_marblenet_v2.0.nemo
# NeMo MarbleNet 使用 GPU（如不设置则自动选择）
VAD_NEMO_DEVICE=cuda
# 语音判定阈值（更高=更保守，可能更碎但更容易漏）
VAD_THRESHOLD=0.60
# 长段切分：目标最长时长（秒），会优先在低概率 valley 处切开
VAD_TARGET_MAX_SEGMENT_S=4
# valley 判定阈值（越低越容易找到 valley，越可能更碎）
VAD_SPLIT_THRESHOLD=0.45
# 静音/语音最短时长（毫秒）
VAD_MIN_SILENCE_DURATION_MS=60
VAD_MIN_SPEECH_DURATION_MS=100
# 切分点搜索窗口（相对 target 时长）
VAD_SPLIT_SEARCH_BACKTRACK_RATIO=0.7
VAD_SPLIT_SEARCH_FORWARD_RATIO=0.03
# 0 = 不人为挖掉音频（不丢音素）；>0 会制造 gap 但有丢字风险
VAD_SPLIT_GAP_S=0

# === 数据库 ===
# Phase 2（大文件去重）使用 PostgreSQL 维护 blob 元数据与引用计数
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=subflow
POSTGRES_HOST=localhost
POSTGRES_PORT=5432

# === Redis ===
REDIS_URL=redis://localhost:6379

# === ASR 配置 (vLLM GLM-ASR) ===
ASR_PROVIDER=glm_asr
ASR_BASE_URL=http://localhost:8000/v1
ASR_MODEL=glm-asr
ASR_API_KEY=abc123
ASR_TIMEOUT=300.0

# === LLM 配置（fast / power）===
# 支持: openai, openai_compat, anthropic

# 快速 LLM（用于简单任务）
LLM_FAST_PROVIDER=openai
LLM_FAST_BASE_URL=https://api.openai.com/v1
LLM_FAST_API_KEY=sk-xxx
LLM_FAST_MODEL=gpt-4

# 强力 LLM（用于复杂任务）
LLM_POWER_PROVIDER=openai
LLM_POWER_BASE_URL=https://api.openai.com/v1
LLM_POWER_API_KEY=sk-xxx
LLM_POWER_MODEL=gpt-4

# 各阶段 LLM 选择（fast / power）
LLM_ASR_CORRECTION=fast
LLM_GLOBAL_UNDERSTANDING=fast
LLM_SEMANTIC_TRANSLATION=power

# === 并发控制（按服务类型）===
# ASR 服务并发数（Stage 3：分段 + 合并块）
CONCURRENCY_ASR=10
# LLM_FAST 服务并发数（Stage 4：ASR 纠错；Stage 5 Pass 1：全局理解）
CONCURRENCY_LLM_FAST=10
# LLM_POWER 服务并发数（Stage 5 Pass 2：语义切分 + 翻译）
CONCURRENCY_LLM_POWER=4

# === Region 分区（Stage 4 + Stage 5 共享）===
# 是否启用基于 VAD region gap 的分区并行
PARALLEL_ENABLED=true
# 最小 region 间隔（秒）：gap >= 此值的 regions 可并行处理
PARALLEL_MIN_GAP_SECONDS=1.0

# === Artifacts ===
# 默认建议使用 MinIO/S3（Worker/API 可分离部署）
ARTIFACT_STORE_BACKEND=s3
S3_PRESIGN_EXPIRES_HOURS=24

# === S3/MinIO ===
S3_ENDPOINT=http://localhost:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET_NAME=subflow

# === 上传配置 ===
# 最大上传文件大小（字节），默认 10GB
UPLOAD_MAX_BYTES=10737418240

# === 目录结构说明 ===
# DATA_DIR (默认 ./data) 包含：
#   - blobs/     : 大文件去重存储（视频/音频/人声，按 SHA256 hash）
#   - uploads/   : 用户上传（如 artifact_store_backend=local）
#   - projects/  : 临时工作目录（demucs 输出等，可定期清理）
#   - exports/   : 本地导出文件缓存
#
# 推荐存储策略：
#   - artifact_store_backend=s3 : 小型 JSON artifacts 存桶，大文件存本地 blobs/
#   - artifact_store_backend=local : 全部存本地（适合单机部署）
